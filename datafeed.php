<?php//include_once("dbconfig.php");require_once './includes/bootstrap.inc';drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);include_once("wdcalendar/php/functions.php");function addCalendar($st, $et, $sub, $ade, $uid, $email){  $ret = array();  try{	$success = false;	$uids = explode('-', $uid);	foreach($uids as $userid){    $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`, `uid`, `status`) values ('"      .mysql_real_escape_string($sub)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."', '"      .$userid."', '"	  ."0"."'	  )";	 	db_query($sql);	$success = true;	}			if($success == false){      $ret['IsSuccess'] = false;      $ret['Msg'] = "An internal server error occured.";    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'The duty was successfully added.';	  $calid = db_last_insert_id("jqcalendar", "id");      $ret['Data'] = $calid;	  	  // module for sending email		$uids = explode('-', $uid);		foreach($uids as $userid){		  if($email == "send"){			sendemail($sub, $st, $et, $userid, $calid);		  }		}	  // eof module for sending email	}	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }    return $ret;}function sendemail($subj, $st, $et, $uid, $calid, $dscr="", $loc=""){ $start = date("M j ga",strtotime($st)); $end = date("ga",strtotime($et)); $datetime = $start.' - '.$end; $to = db_result(db_query("select mail from users where uid = '".$uid."'")); $from = "admin@firsthopecorps.org";  $subject = "Notification: ".$subj." @ ".$datetime;  $headers = "From: " . strip_tags($from) . "\r\n"; $headers .= "Reply-To: ". strip_tags("no-reply@firsthopecorps.org") . "\r\n"; $headers .= "MIME-Version: 1.0\r\n"; $headers .= "Content-Type: text/html; charset=ISO-8859-1\r\n"; $remarks = $dscr; $location = $loc;  $text = '<table cellspacing="0" cellpadding="8" border="0" style="width: 100%; font-family: Arial,Sans-serif; border-style: solid; border-color: rgb(204, 204, 204); border-width: 1px 2px 2px 1px; background-color: rgb(255, 255, 255);">			<tbody>			<tr>			<td>			<div style="padding: 2px;">			<div style="float: right; font-weight: bold; font-size: 13px;">			<!--<a href="http://www.hopecybrary.org/dutyaction.php?id='.$calid.'" target="_blank" rel="nofollow">more details »</a>-->			<br>			</div>			<h3 style="padding: 0pt 0pt 6px; margin: 0pt; font-family: Arial,Sans-serif; font-size: 16px; font-weight: bold; color: rgb(34, 34, 34);">'.$subj.'</h3>			<div style="padding-bottom: 15px; font-size: 13px; color: rgb(34, 34, 34); white-space: pre-wrap ! important; word-wrap: break-word;">'.$remarks.'</div>			<table cellspacing="0" cellpadding="0" border="0">			<tbody>			<tr>			<td valign="top" style="padding: 0pt 1em 10px 0pt; font-family: Arial,Sans-serif; font-size: 13px; color: rgb(136, 136, 136); white-space: nowrap;">			<div>			<i style="font-style: normal;">When</i>			</div>			</td>			<td valign="top" style="padding-bottom: 10px; font-family: Arial,Sans-serif; font-size: 13px; color: rgb(34, 34, 34);">			'.$datetime.'			<span style="color: rgb(136, 136, 136);">Manila</span>			</td>			</tr>			<tr id="yui_3_2_0_1_1316067472160117">			<td valign="top" style="padding: 0pt 1em 10px 0pt; font-family: Arial,Sans-serif; font-size: 13px; color: rgb(136, 136, 136); white-space: nowrap;">			<div>			<i style="font-style: normal;">Location</i>			</div>			</td>			<td valign="top" style="padding-bottom: 10px; font-family: Arial,Sans-serif; font-size: 13px; color: rgb(34, 34, 34);">			'.$location.'			</td>			</tr>			</tbody>			</table>			</div>			<p style="color: rgb(34, 34, 34); font-size: 13px; margin: 0pt;">			<span style="color: rgb(136, 136, 136);">Going?&nbsp;&nbsp;&nbsp;</span>			<!--<strong><a href="http://www.hopecybrary.org/dutyaction.php?id='.$calid.'&respond=1" target="_blank">Yes</a><span style="margin: 0pt 0.4em; font-weight: normal;"> - </span><a href="http://www.hopecybrary.org/dutyaction.php?id='.$calid.'&respond=0" target="_blank">No</a>-->			click <a href="http://www.hopecybrary.org/dutyaction.php?id='.$calid.'" target="_blank" rel="nofollow">here</a> for more details »			</strong>			</p>			</td>			</tr>			<tr>			<td style="background-color: rgb(246, 246, 246); color: rgb(136, 136, 136); border-top: 1px solid rgb(204, 204, 204); font-family: Arial,Sans-serif; font-size: 11px;">			<p>			Notification from			<a style="" href="http://www.hopecybrary.org/mystudies/getinvolved/cybrarian" target="_blank" rel="nofollow">HopeNet</a>			</p>			<p>You are receiving this courtesy email at the account admin@firsthopecorps.org because you are a cybrarian volunteer of HopeNet.</p>			</td>			</tr>			</tbody>		</table>';	    $from = _rsc($from);    $to = _rsc($to);    $subject = _rsc($subject);    mail($to, $subject, $text, $headers);		return true;}function _rsc($s){        $s = str_replace("\n", '', $s);        $s = str_replace("\r", '', $s);        return $s;}function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz, $uid, $email){  $ret = array();  try{	$success = false;	$uids = explode('-', $uid);	foreach($uids as $userid){    $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`, `uid`, `status`) values ('"      .mysql_real_escape_string($sub)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"	  .mysql_real_escape_string($color)."', '"	  .$userid."', '"      ."0"."' )";	 	db_query($sql);	$success = true;	}		if($success == false){      $ret['IsSuccess'] = false;      $ret['Msg'] = "An internal server error occured.";    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'The duty was successfully added.';      $calid = db_last_insert_id("jqcalendar", "id");	  $ret['Data'] = $calid;	  		$uids = explode('-', $uid);		foreach($uids as $userid){		  if($email == "send"){			sendemail($sub, $st, $et, $userid, $calid, $dscr, $loc);		  }		}    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }    return $ret;}function listCalendarByRange($sd, $ed, $uid){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  try{	$uids = str_replace("-",", ", $uid);    $sql = "select * from `jqcalendar` where `status` != 10 and `uid` IN (".$uids.") and `starttime` between '"      .php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."'";	      $handle = db_query($sql);	while ($row = db_fetch_object($handle)){	  $status = "Pending";	  	  if($row->status == 1){	  $status = "Accepted";	  } else if($row->status == 2){	  $status = "Declined";	  	  }	  	  $comment = "No response, yet.";	  if($row->comment !== NULL){	  $comment = $row->comment;	  }	  	  $username = db_result(db_query("select name from users where uid = '".$row->uid."' "));	        $ret['events'][] = array(        $row->Id,        $row->Subject.'|'.$status.'|'.$comment.'|'.$username.'|',        php2JsTime(mySql2PhpTime($row->StartTime)),        php2JsTime(mySql2PhpTime($row->EndTime)),        $row->IsAllDayEvent,        0, //more than one day event        //$row->InstanceType,        0,//Recurring event,        $row->Color,        1,//editable        $row->Location,         ''//$attends      );    }	}catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type, $uid){  $phpTime = js2PhpTime($day);  //echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  //echo $st . "--" . $et;  return listCalendarByRange($st, $et, $uid);}function updateCalendar($id, $st, $et){  $ret = array();  try{    $sql = "update `jqcalendar` set"      . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "' "      . "where `id`=" . $id;	if(db_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = "An internal server error occured.";    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'The duty was successfully updated.';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }    return $ret;}function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  try{    $sql = "update `jqcalendar` set"      . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "', "      . " `subject`='" . mysql_real_escape_string($sub) . "', "      . " `isalldayevent`='" . mysql_real_escape_string($ade) . "', "      . " `description`='" . mysql_real_escape_string($dscr) . "', "      . " `location`='" . mysql_real_escape_string($loc) . "', "      . " `color`='" . mysql_real_escape_string($color) . "' "      . "where `id`=" . $id;	      //echo $sql;	if(db_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = "An internal server error occured.";    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'The duty was successfully updated.';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{    $sql = "delete from `jqcalendar` where `id`=" . $id;		if(db_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = "An internal server error occured.";    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'The duty was successfully deleted.';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];$uid = $_GET["uid"];switch ($method) {    case "add":        $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"], $uid, $_POST['email']);        break;    case "list":        $ret = listCalendar($_POST["showdate"], $_POST["viewtype"], $uid);        break;    case "update":        $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);        break;     case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        break;    case "adddetails":        $st = $_POST["stpartdate"] . " " . $_POST["stparttime"];        $et = $_POST["etpartdate"] . " " . $_POST["etparttime"];        if(isset($_GET["id"])){            $ret = updateDetailedCalendar($_GET["id"], $st, $et,                 $_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],                 $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);        }else{            $ret = addDetailedCalendar($st, $et,                                    $_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],                 $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"], $uid, $_POST["email"]);        }                break; }echo json_encode($ret);?>