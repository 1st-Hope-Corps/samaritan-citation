<?php

/**
 * Implements hook_menu().
 */
function fboauth_menu() {
  $items['fboauth/%fboauth_action'] = array(
    'title' => 'Facebook connect',
    'page callback' => 'fboauth_action_page',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'file' => 'includes/fboauth.fboauth.inc',
    'type' => MENU_CALLBACK,
  );
  $items['admin/settings/fboauth'] = array(
    'title' => t('Facebook OAuth settings'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fboauth_settings_form'),
    'access arguments' => array('administer users'),
    'file' => 'includes/fboauth.pages.inc',
    'description' => 'Configure site for Facebook Connect and map Facebook information to user profiles.',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['user/%user/fboauth'] = array(
    'title' => t('Facebook settings'),
    'page callback' => 'fboauth_user_form',
    'page arguments' => array(1),
    'access callback' => 'user_edit_access',
#    'access arguments' => array(1),
    'access arguments' => array('access content'),
    'file' => 'includes/fboauth.pages.inc',
  );
  
  $items['fboauth/changeinfo/%'] = array(
    'title' => 'Update Information',
	'page callback' => 'fbauth_change_info',
	'page arguments' => array(2),
	'access arguments' => array('access content'),
	'type' => MENU_CALLBACK
  );
  
  $items['fboauth/fbchangeinfo/%'] = array(
    'title' => 'Update Information',
	'page callback' => 'fbauth_fbchange_info',
	'page arguments' => array(2),
	'access arguments' => array('access content'),
	'type' => MENU_CALLBACK
  );
  
  $items['fboauth/updateinfo'] = array(
    'title' => 'Update Information',
	'page callback' => 'fbauth_update_info',
	'access arguments' => array('access content'),
	'type' => MENU_CALLBACK
  );
  
  return $items;
}

function _change_info($uid){
	global $user;
	global $base_url;

	if($user->name !== 'admin'){
		echo '<script>location.href="'.$base_url.'/fboauth/changeinfo/'.$uid.'";</script>';	
	}
}

/**
 * Implements hook_theme().
 */
 
function fbauth_update_info(){
	
	$uid = $_POST['uid'];
	$name = $_POST['name'];
	//$pass = md5($_POST['pass']);
	$lastname = $_POST['lastname'];
	$firstname = $_POST['firstname'];
	$address = $_POST['address'];
	$city = $_POST['city'];
	$state = $_POST['state'];
	$country = $_POST['country'];
	$gender = $_POST['gender'];
	$month = $_POST['month'];
	$day = $_POST['day'];
	$year = $_POST['year'];
	$date = 'a:3:{s:5:"month";s:1:"'.$month.'";s:3:"day";s:2:"'.$day.'";s:4:"year";s:4:"'.$year.'";}';
	
	
	db_query("UPDATE {users} SET name = '{$name}' WHERE uid = '{$uid}'");
	
	// Retrieves the profile entry count
	$sqlEntryCount = "SELECT COUNT(fid)
						FROM profile_values
						WHERE fid IN (1, 2, 3, 4, 5, 57, 58, 59)
							AND uid = %d";
	
	$iEntryCount = db_result(db_query($sqlEntryCount, $uid));
	
	// If there are 8 profile entries, update the data. Else, insert new data.
	if ($iEntryCount == 8){
		db_query("UPDATE {profile_values} SET value = '{$lastname}' WHERE uid = '{$uid}' and fid = '1'");
		db_query("UPDATE {profile_values} SET value = '{$firstname}' WHERE uid = '{$uid}' and fid = '2'");
		db_query("UPDATE {profile_values} SET value = '{$address}' WHERE uid = '{$uid}' and fid = '3'");
		db_query("UPDATE {profile_values} SET value = '{$city}' WHERE uid = '{$uid}' and fid = '57'");
		db_query("UPDATE {profile_values} SET value = '{$state}' WHERE uid = '{$uid}' and fid = '58'");
		db_query("UPDATE {profile_values} SET value = '{$country}' WHERE uid = '{$uid}' and fid = '59'");
		db_query("UPDATE {profile_values} SET value = '{$gender}' WHERE uid = '{$uid}' and fid = '4'");
		db_query("UPDATE {profile_values} SET value = '{$date}' WHERE uid = '{$uid}' and fid = '5'");
	}else{
		// Clean the table first if there are any initial data
		$sqlDelete = "DELETE FROM profile_values WHERE uid = %d";
		db_query($sqlDelete, $uid);
		
		// SQL template for the inserts
		$sqlInsert = "INSERT INTO {profile_values} VALUES(%d, %d, '%s')";
		
		// Insert the applicable data
		db_query($sqlInsert, 1, $uid, $lastname);
		db_query($sqlInsert, 2, $uid, $firstname);
		db_query($sqlInsert, 3, $uid, $address);
		db_query($sqlInsert, 4, $uid, $gender);
		db_query($sqlInsert, 5, $uid, $date);
		db_query($sqlInsert, 57, $uid, $city);
		db_query($sqlInsert, 58, $uid, $state);
		db_query($sqlInsert, 59, $uid, $country);
	}
	
	echo json_encode(array("STATUS" => "Success"));
}

function fbauth_fbchange_info($uid){
	global $base_url;
	
	$sBoxJS = '<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
				<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
				<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>';
  

	$sBoxJS = '<script>
				$("document").ready(
					function(){
						$("#usernotify_Dialog")
							.html("Thank you for your interest in joining HopeGames. Please update your information to complete your registration.")
							.dialog(
								{
									modal: true,
									autoOpen: true,
									resizable: false,
									width: 530,
									buttons: {
										"Close": function(){
											$(this).dialog("close");
										}
									}
								}
							);
					}
				);</script>';
	
	$select_uid = db_query("select * from users where uid = '".$uid."'");	
	$rowUID = db_fetch_object($select_uid);
	
	$name = $rowUID->name;
	$email = $rowUID->mail;
	$app_id = variable_get('fbapp_id', '636255993085643');
	
$html = '
<script>
function validateUpdateInfo(myform){
	err = "";
	document.getElementById("divUpdateError").innerHTML = "";
	
	if (myform.profile_username.value == "")
		err += "Please input your Username.<br />";
	if (myform.profile_last_name.value == "")
		err += "Please input your Last Name.<br />";
	if (myform.profile_first_name.value == "")
		err += "Please input your First Name.<br />";	
	if (myform.profile_address.value == "")
		err += "Please input your Address.<br />";	
	if (myform.profile_city.value == "")
		err += "Please input your City.<br />";	
	if (myform.profile_state.value == "")
		err += "Please input your State/Province.<br />";	
    if (myform.profile_country.value == "")
		err += "Please input your Country.<br />";	
    if (myform.profile_gender.value == "")
		err += "Please input your Gender.<br />";	

	if (err != "") {
	document.getElementById("divUpdateError").innerHTML = err;
	return false;
	} else{		
		$.post(
			"'.((base_path() != '/') ? base_path().'/':'/').'?q=fboauth/updateinfo",
			{ 
			  uid:myform.uid.value,
			  name:myform.profile_username.value,
			  //pass:myform.pass.value,
			  lastname:myform.profile_last_name.value,
              firstname:myform.profile_first_name.value,
			  address:myform.profile_address.value,
              city:myform.profile_city.value,
			  state:myform.profile_state.value,
			  country:myform.profile_country.value,		
			  gender:myform.profile_gender.value,
			  month:$("#edit-profile-dob-month").val(),
			  day:$("#edit-profile-dob-day").val(),
			  year:$("#edit-profile-dob-year").val()
			},
			function(sReply){
				alert("Thank you for registering to HopeGames. Please wait for the admin to review and activate your account.");
				
				top.location.href= "https://apps.facebook.com/'.$app_id.'/";
			},
			"json"
		);
	}
	
	return false;
}
</script>
<div id="divUpdateError" style="color:red;">&nbsp;</div>
<form id="UpdateInfo" action="/user" method="post" onSubmit="return validateUpdateInfo(this);">
<h2>Required Information</h2>
<fieldset><legend>Account information</legend><div class="form-item" id="edit-name-wrapper">
  <div class="form-item">
  <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
  <input type="text" id="edit-profile-username" name="profile_username" value=""  size="60" class="form-text required" />
  </div>
  
  <!--div class="form-item">
  <label for="edit-name">Email: <span class="form-required" title="This field is required.">*</span></label>
  <input type="text" id="edit-profile-email" name="profile_email" value=""  size="60" class="form-text required" />
  </div-->
  
  <input type="hidden" id="uid" name="uid" value="'.$uid.'" />
  
<!--div class="form-item" id="edit-mail-wrapper">
  <input type="hidden" name="pass" id="edit-pass" size="60" value="default" class="form-text required" />
</div-->

<!--<div class="form-item" id="edit-mail-wrapper">
 <label for="edit-mail">Confirm password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" maxlength="64" name="confpass" id="edit-confpass" size="60" value="" class="form-text required" />
</div>-->
</fieldset>

<fieldset><legend>I. Personal Info</legend><div class="form-item" id="edit-profile-last-name-wrapper">
 <label for="edit-profile-last-name">Last Name: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_last_name" id="edit-profile-last-name" size="60" value="" class="form-text required" />
 <div class="description"> The content of this field is kept private and will not be shown publicly.</div>
</div>
<div class="form-item" id="edit-profile-first-name-wrapper">
 <label for="edit-profile-first-name">First Name: <span class="form-required" title="This field is required.">*</span></label>

 <input type="text" maxlength="255" name="profile_first_name" id="edit-profile-first-name" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-address-wrapper">
 <label for="edit-profile-address">Home Address: <span class="form-required" title="This field is required.">*</span></label>
 <textarea cols="60" rows="5" name="profile_address" id="edit-profile-address"  class="form-textarea resizable required"></textarea>
 <div class="description"> The content of this field is kept private and will not be shown publicly.</div>
</div>
<div class="form-item" id="edit-profile-city-wrapper">

 <label for="edit-profile-city">City: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_city" id="edit-profile-city" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-state-wrapper">
 <label for="edit-profile-state">State/Province: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_state" id="edit-profile-state" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-country-wrapper">
 <label for="edit-profile-country">Country: <span class="form-required" title="This field is required.">*</span></label>

 <select name="profile_country" class="form-select required" id="edit-profile-country" ><option value="Philippines">Philippines</option><option value="Afghanistan">Afghanistan</option><option value="Albania">Albania</option><option value="Algeria">Algeria</option><option value="American Samoa">American Samoa</option><option value="Andorra">Andorra</option><option value="Angola">Angola</option><option value="Anguilla">Anguilla</option><option value="Antarctica">Antarctica</option><option value="Antigua and Barbuda">Antigua and Barbuda</option><option value="Argentina">Argentina</option><option value="Armenia">Armenia</option><option value="Aruba">Aruba</option><option value="Australia">Australia</option><option value="Austria">Austria</option><option value="Azerbaijan">Azerbaijan</option><option value="Bahamas">Bahamas</option><option value="Bahrain">Bahrain</option><option value="Bangladesh">Bangladesh</option><option value="Barbados">Barbados</option><option value="Belarus">Belarus</option><option value="Belgium">Belgium</option><option value="Belize">Belize</option><option value="Benin">Benin</option><option value="Bermuda">Bermuda</option><option value="Bhutan">Bhutan</option><option value="Bolivia">Bolivia</option><option value="Bosnia and Herzegowina">Bosnia and Herzegowina</option><option value="Botswana">Botswana</option><option value="Bouvet Island">Bouvet Island</option><option value="Brazil">Brazil</option><option value="British Indian Ocean Territory">British Indian Ocean Territory</option><option value="Brunei Darussalam">Brunei Darussalam</option><option value="Bulgaria">Bulgaria</option><option value="Burkina Faso">Burkina Faso</option><option value="Burundi">Burundi</option><option value="Cambodia">Cambodia</option><option value="Cameroon">Cameroon</option><option value="Canada">Canada</option><option value="Cape Verde">Cape Verde</option><option value="Cayman Islands">Cayman Islands</option><option value="Central African Republic">Central African Republic</option><option value="Chad">Chad</option><option value="Chile">Chile</option><option value="China">China</option><option value="Christmas Island">Christmas Island</option><option value="Cocos (Keeling) Islands">Cocos (Keeling) Islands</option><option value="Colombia">Colombia</option><option value="Comoros">Comoros</option><option value="Congo">Congo</option><option value="Cook Islands">Cook Islands</option><option value="Costa Rica">Costa Rica</option><option value="Cote D&#039;Ivoire">Cote D&#039;Ivoire</option><option value="Croatia">Croatia</option><option value="Cuba">Cuba</option><option value="Cyprus">Cyprus</option><option value="Czech Republic">Czech Republic</option><option value="Denmark">Denmark</option><option value="Djibouti">Djibouti</option><option value="Dominica">Dominica</option><option value="Dominican Republic">Dominican Republic</option><option value="East Timor">East Timor</option><option value="Ecuador">Ecuador</option><option value="Egypt">Egypt</option><option value="El Salvador">El Salvador</option><option value="Equatorial Guinea">Equatorial Guinea</option><option value="Eritrea">Eritrea</option><option value="Estonia">Estonia</option><option value="Ethiopia">Ethiopia</option><option value="Falkland Islands (Malvinas)">Falkland Islands (Malvinas)</option><option value="Faroe Islands">Faroe Islands</option><option value="Fiji">Fiji</option><option value="Finland">Finland</option><option value="France">France</option><option value="France, Metropolitan">France, Metropolitan</option><option value="French Guiana">French Guiana</option><option value="French Polynesia">French Polynesia</option><option value="French Southern Territories">French Southern Territories</option><option value="Gabon">Gabon</option><option value="Gambia">Gambia</option><option value="Georgia">Georgia</option><option value="Germany">Germany</option><option value="Ghana">Ghana</option><option value="Gibraltar">Gibraltar</option><option value="Greece">Greece</option><option value="Greenland">Greenland</option><option value="Grenada">Grenada</option><option value="Guadeloupe">Guadeloupe</option><option value="Guam">Guam</option><option value="Guatemala">Guatemala</option><option value="Guinea">Guinea</option><option value="Guinea-bissau">Guinea-bissau</option><option value="Guyana">Guyana</option><option value="Haiti">Haiti</option><option value="Heard and Mc Donald Islands">Heard and Mc Donald Islands</option><option value="Honduras">Honduras</option><option value="Hong Kong">Hong Kong</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="India">India</option><option value="Indonesia">Indonesia</option><option value="Iran (Islamic Republic of)">Iran (Islamic Republic of)</option><option value="Iraq">Iraq</option><option value="Ireland">Ireland</option><option value="Israel">Israel</option><option value="Italy">Italy</option><option value="Jamaica">Jamaica</option><option value="Japan">Japan</option><option value="Jordan">Jordan</option><option value="Kazakhstan">Kazakhstan</option><option value="Kenya">Kenya</option><option value="Kiribati">Kiribati</option><option value="Korea, Democratic People&#039;s Republic of">Korea, Democratic People&#039;s Republic of</option><option value="Korea, Republic of">Korea, Republic of</option><option value="Kuwait">Kuwait</option><option value="Kyrgyzstan">Kyrgyzstan</option><option value="Lao People&#039;s Democratic Republic">Lao People&#039;s Democratic Republic</option><option value="Latvia">Latvia</option><option value="Lebanon">Lebanon</option><option value="Lesotho">Lesotho</option><option value="Liberia">Liberia</option><option value="Libyan Arab Jamahiriya">Libyan Arab Jamahiriya</option><option value="Liechtenstein">Liechtenstein</option><option value="Lithuania">Lithuania</option><option value="Luxembourg">Luxembourg</option><option value="Macau">Macau</option><option value="Macedonia, The Former Yugoslav Republic of">Macedonia, The Former Yugoslav Republic of</option><option value="Madagascar">Madagascar</option><option value="Malawi">Malawi</option><option value="Malaysia">Malaysia</option><option value="Maldives">Maldives</option><option value="Mali">Mali</option><option value="Malta">Malta</option><option value="Marshall Islands">Marshall Islands</option><option value="Martinique">Martinique</option><option value="Mauritania">Mauritania</option><option value="Mauritius">Mauritius</option><option value="Mayotte">Mayotte</option><option value="Mexico">Mexico</option><option value="Micronesia, Federated States of">Micronesia, Federated States of</option><option value="Moldova, Republic of">Moldova, Republic of</option><option value="Monaco">Monaco</option><option value="Mongolia">Mongolia</option><option value="Montserrat">Montserrat</option><option value="Morocco">Morocco</option><option value="Mozambique">Mozambique</option><option value="Myanmar">Myanmar</option><option value="Namibia">Namibia</option><option value="Nauru">Nauru</option><option value="Nepal">Nepal</option><option value="Netherlands">Netherlands</option><option value="Netherlands Antilles">Netherlands Antilles</option><option value="New Caledonia">New Caledonia</option><option value="New Zealand">New Zealand</option><option value="Nicaragua">Nicaragua</option><option value="Niger">Niger</option><option value="Nigeria">Nigeria</option><option value="Niue">Niue</option><option value="Norfolk Island">Norfolk Island</option><option value="Northern Mariana Islands">Northern Mariana Islands</option><option value="Norway">Norway</option><option value="Oman">Oman</option><option value="Pakistan">Pakistan</option><option value="Palau">Palau</option><option value="Panama">Panama</option><option value="Papua New Guinea">Papua New Guinea</option><option value="Paraguay">Paraguay</option><option value="Peru">Peru</option><option value="Pitcairn">Pitcairn</option><option value="Poland">Poland</option><option value="Portugal">Portugal</option><option value="Puerto Rico">Puerto Rico</option><option value="Qatar">Qatar</option><option value="Reunion">Reunion</option><option value="Romania">Romania</option><option value="Russian Federation">Russian Federation</option><option value="Rwanda">Rwanda</option><option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option><option value="Saint Lucia">Saint Lucia</option><option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option><option value="Samoa">Samoa</option><option value="San Marino">San Marino</option><option value="Sao Tome and Principe">Sao Tome and Principe</option><option value="Saudi Arabia">Saudi Arabia</option><option value="Senegal">Senegal</option><option value="Seychelles">Seychelles</option><option value="Sierra Leone">Sierra Leone</option><option value="Singapore">Singapore</option><option value="Slovakia (Slovak Republic)">Slovakia (Slovak Republic)</option><option value="Slovenia">Slovenia</option><option value="Solomon Islands">Solomon Islands</option><option value="Somalia">Somalia</option><option value="South Africa">South Africa</option><option value="South Georgia and the South Sandwich Islands">South Georgia and the South Sandwich Islands</option><option value="Spain">Spain</option><option value="Sri Lanka">Sri Lanka</option><option value="St. Helena">St. Helena</option><option value="St. Pierre and Miquelon">St. Pierre and Miquelon</option><option value="Sudan">Sudan</option><option value="Suriname">Suriname</option><option value="Svalbard and Jan Mayen Islands">Svalbard and Jan Mayen Islands</option><option value="Swaziland">Swaziland</option><option value="Sweden">Sweden</option><option value="Switzerland">Switzerland</option><option value="Syrian Arab Republic">Syrian Arab Republic</option><option value="Taiwan">Taiwan</option><option value="Tajikistan">Tajikistan</option><option value="Tanzania, United Republic of">Tanzania, United Republic of</option><option value="Thailand">Thailand</option><option value="Togo">Togo</option><option value="Tokelau">Tokelau</option><option value="Tonga">Tonga</option><option value="Trinidad and Tobago">Trinidad and Tobago</option><option value="Tunisia">Tunisia</option><option value="Turkey">Turkey</option><option value="Turkmenistan">Turkmenistan</option><option value="Turks and Caicos Islands">Turks and Caicos Islands</option><option value="Tuvalu">Tuvalu</option><option value="Uganda">Uganda</option><option value="Ukraine">Ukraine</option><option value="United Arab Emirates">United Arab Emirates</option><option value="United Kingdom">United Kingdom</option><option value="United States">United States</option><option value="United States Minor Outlying Islands">United States Minor Outlying Islands</option><option value="Uruguay">Uruguay</option><option value="Uzbekistan">Uzbekistan</option><option value="Vanuatu">Vanuatu</option><option value="Vatican City State (Holy See)">Vatican City State (Holy See)</option><option value="Venezuela">Venezuela</option><option value="Viet Nam">Viet Nam</option><option value="Virgin Islands (British)">Virgin Islands (British)</option><option value="Virgin Islands (U.S.)">Virgin Islands (U.S.)</option><option value="Wallis and Futuna Islands">Wallis and Futuna Islands</option><option value="Western Sahara">Western Sahara</option><option value="Yemen">Yemen</option><option value="Yugoslavia">Yugoslavia</option><option value="Zaire">Zaire</option><option value="Zambia">Zambia</option><option value="Zimbabwe">Zimbabwe</option></select>
</div>
<div class="form-item" id="edit-profile-gender-wrapper">
 <label for="edit-profile-gender">Gender: <span class="form-required" title="This field is required.">*</span></label>
 <select name="profile_gender" class="form-select required" id="edit-profile-gender" ><option value="Male">Male</option><option value="Female">Female</option></select>
</div>
<div class="form-item" id="edit-profile-dob-wrapper">
 <label for="edit-profile-dob">Birthdate: <span class="form-required" title="This field is required.">*</span></label>
 <div class="container-inline"><div class="form-item" id="edit-profile-dob-month-wrapper">

 <select name="profile_dob[month]" class="form-select" id="edit-profile-dob-month" ><option value="1">Jan</option><option value="2" selected="selected">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option></select>
</div>
<div class="form-item" id="edit-profile-dob-day-wrapper">
 <select name="profile_dob[day]" class="form-select" id="edit-profile-dob-day" ><option value="1">1</option><option value="2" selected="selected">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option></select>

</div>
<div class="form-item" id="edit-profile-dob-year-wrapper">
 <select name="profile_dob[year]" class="form-select" id="edit-profile-dob-year" ><option value="1900">1900</option><option value="1901">1901</option><option value="1902">1902</option><option value="1903">1903</option><option value="1904">1904</option><option value="1905">1905</option><option value="1906">1906</option><option value="1907">1907</option><option value="1908">1908</option><option value="1909">1909</option><option value="1910">1910</option><option value="1911">1911</option><option value="1912">1912</option><option value="1913">1913</option><option value="1914">1914</option><option value="1915">1915</option><option value="1916">1916</option><option value="1917">1917</option><option value="1918">1918</option><option value="1919">1919</option><option value="1920">1920</option><option value="1921">1921</option><option value="1922">1922</option><option value="1923">1923</option><option value="1924">1924</option><option value="1925">1925</option><option value="1926">1926</option><option value="1927">1927</option><option value="1928">1928</option><option value="1929">1929</option><option value="1930">1930</option><option value="1931">1931</option><option value="1932">1932</option><option value="1933">1933</option><option value="1934">1934</option><option value="1935">1935</option><option value="1936">1936</option><option value="1937">1937</option><option value="1938">1938</option><option value="1939">1939</option><option value="1940">1940</option><option value="1941">1941</option><option value="1942">1942</option><option value="1943">1943</option><option value="1944">1944</option><option value="1945">1945</option><option value="1946">1946</option><option value="1947">1947</option><option value="1948">1948</option><option value="1949">1949</option><option value="1950">1950</option><option value="1951">1951</option><option value="1952">1952</option><option value="1953">1953</option><option value="1954">1954</option><option value="1955">1955</option><option value="1956">1956</option><option value="1957">1957</option><option value="1958">1958</option><option value="1959">1959</option><option value="1960">1960</option><option value="1961">1961</option><option value="1962">1962</option><option value="1963">1963</option><option value="1964">1964</option><option value="1965">1965</option><option value="1966">1966</option><option value="1967">1967</option><option value="1968">1968</option><option value="1969">1969</option><option value="1970">1970</option><option value="1971">1971</option><option value="1972">1972</option><option value="1973">1973</option><option value="1974">1974</option><option value="1975">1975</option><option value="1976">1976</option><option value="1977">1977</option><option value="1978">1978</option><option value="1979">1979</option><option value="1980">1980</option><option value="1981">1981</option><option value="1982">1982</option><option value="1983">1983</option><option value="1984">1984</option><option value="1985">1985</option><option value="1986">1986</option><option value="1987">1987</option><option value="1988">1988</option><option value="1989">1989</option><option value="1990">1990</option><option value="1991">1991</option><option value="1992">1992</option><option value="1993">1993</option><option value="1994">1994</option><option value="1995">1995</option><option value="1996">1996</option><option value="1997">1997</option><option value="1998">1998</option><option value="1999">1999</option><option value="2000">2000</option><option value="2001">2001</option><option value="2002">2002</option><option value="2003">2003</option><option value="2004">2004</option><option value="2005">2005</option><option value="2006">2006</option><option value="2007">2007</option><option value="2008">2008</option><option value="2009">2009</option><option value="2010">2010</option><option value="2011">2011</option><option value="2012" selected="selected">2012</option><option value="2013">2013</option><option value="2014">2014</option><option value="2015">2015</option><option value="2016">2016</option><option value="2017">2017</option><option value="2018">2018</option><option value="2019">2019</option><option value="2020">2020</option><option value="2021">2021</option><option value="2022">2022</option><option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option><option value="2031">2031</option><option value="2032">2032</option><option value="2033">2033</option><option value="2034">2034</option><option value="2035">2035</option><option value="2036">2036</option><option value="2037">2037</option><option value="2038">2038</option><option value="2039">2039</option><option value="2040">2040</option><option value="2041">2041</option><option value="2042">2042</option><option value="2043">2043</option><option value="2044">2044</option><option value="2045">2045</option><option value="2046">2046</option><option value="2047">2047</option><option value="2048">2048</option><option value="2049">2049</option><option value="2050">2050</option></select></fieldset>
<input id="edit-submit" class="form-submit" type="submit" value="Update account" name="op">
</div>
</div>
</div></form>';	
			
	return $html.$sBoxJS;

}
 
function fbauth_change_info($uid){

	global $base_url;

	$sBoxJS = '<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
				 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
				 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>';
  

	$sBoxJS .= '<script>
				$("document").ready(
					function(){
						$("#usernotify_Dialog").dialog(
							{
								modal: true,
								autoOpen: true,
								resizable: false,
								width: 530,
								buttons: {
									"Close": function(){
										$(this).dialog("close");
									}
								}
							}
						);
					}
				);
				</script>';
	
	$select_uid = db_query("select * from users where uid = '".$uid."'");	
	$rowUID = db_fetch_object($select_uid);

	$name = $rowUID->name;
	$email = $rowUID->mail;
	$app_id = variable_get('fboauth_id', '');
	
$html = '
<script>
function validateUpdateInfo(myform){
	err = "";
	document.getElementById("divUpdateError").innerHTML = "";
	
	if (myform.profile_username.value == "")
		err += "Please input your username.<br />";
	//if (myform.pass.value == "")
	//	err += "Please input your password.<br />";
	if (myform.confpass.value == "")
		err += "Please input your confirm password.<br />";
	if (myform.profile_last_name.value == "")
		err += "Please input your last name.<br />";
	if (myform.profile_first_name.value == "")
		err += "Please input your firs tname.<br />";	
	if (myform.profile_address.value == "")
		err += "Please input your address.<br />";	
	if (myform.profile_city.value == "")
		err += "Please input your city.<br />";	
	if (myform.profile_state.value == "")
		err += "Please input your state.<br />";	
    if (myform.profile_country.value == "")
		err += "Please input your country.<br />";	
    if (myform.profile_gender.value == "")
		err += "Please input your gender.<br />";	
	
	//if(myform.pass.value !== myform.confpass.value){
	//	err += "Your password did not match.<br />";	
	//}
	
	if (err != "") {
		document.getElementById("divUpdateError").innerHTML = err;
		return false;
	} else{		
		
		$.post(
			"/fboauth/updateinfo",
			{ 
			  uid:myform.uid.value,
			  name:myform.profile_username.value,
			  //pass:myform.pass.value,
			  lastname:myform.profile_last_name.value,
              firstname:myform.profile_first_name.value,
			  address:myform.profile_address.value,
              city:myform.profile_city.value,
			  state:myform.profile_state.value,
			  country:myform.profile_country.value,		
			  gender:myform.profile_gender.value,
			  month:$("#edit-profile-dob-month").val(),
			  day:$("#edit-profile-dob-day").val(),
			  year:$("#edit-profile-dob-year").val()
			},
			function(sReply){
				alert("Thank you for registering to HopeGames. Please wait for the admin to review and activate your account.");
				
				top.location.href= "'.$base_url.'";

			},
			"json"
		);
	}
	
	return false;
}
</script>';

$html .= '
<div id="divUpdateError" style="color:red;">&nbsp;</div>
<form id="UpdateInfo" action="/user" method="post" ">
<h2>Required Information</h2>
<fieldset><legend>Account information</legend><div class="form-item" id="edit-name-wrapper">
  <div class="form-item">
  <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
  <input type="text" id="edit-profile-username" name="profile_username" value="'.$name.'"  size="60" class="form-text required" />
  </div>
  
  <div class="form-item">
  <label for="edit-name">Email: <span class="form-required" title="This field is required.">*</span></label>
  <input type="text" id="edit-profile-email" name="profile_email" value="'.$email.'"  size="60" class="form-text required" />
  </div>
  
  <input type="hidden" id="uid" name="uid" value="'.$uid.'" />
  
<!--div class="form-item" id="edit-mail-wrapper">
 <label for="edit-name">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" maxlength="64" name="pass" id="edit-pass" size="60" value="" class="form-text required" />
</div-->>
<!--div class="form-item" id="edit-mail-wrapper">
 <label for="edit-mail">Confirm password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" maxlength="64" name="confpass" id="edit-confpass" size="60" value="" class="form-text required" />
</div-->
</fieldset>

<fieldset><legend>I. Personal Info</legend><div class="form-item" id="edit-profile-last-name-wrapper">
 <label for="edit-profile-last-name">Last Name: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_last_name" id="edit-profile-last-name" size="60" value="" class="form-text required" />
 <div class="description"> The content of this field is kept private and will not be shown publicly.</div>
</div>
<div class="form-item" id="edit-profile-first-name-wrapper">
 <label for="edit-profile-first-name">First Name: <span class="form-required" title="This field is required.">*</span></label>

 <input type="text" maxlength="255" name="profile_first_name" id="edit-profile-first-name" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-address-wrapper">
 <label for="edit-profile-address">Home Address: <span class="form-required" title="This field is required.">*</span></label>
 <textarea cols="60" rows="5" name="profile_address" id="edit-profile-address"  class="form-textarea resizable required"></textarea>
 <div class="description"> The content of this field is kept private and will not be shown publicly.</div>
</div>
<div class="form-item" id="edit-profile-city-wrapper">

 <label for="edit-profile-city">City: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_city" id="edit-profile-city" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-state-wrapper">
 <label for="edit-profile-state">State/Province: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="255" name="profile_state" id="edit-profile-state" size="60" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-profile-country-wrapper">
 <label for="edit-profile-country">Country: <span class="form-required" title="This field is required.">*</span></label>

 <select name="profile_country" class="form-select required" id="edit-profile-country" ><option value="Philippines">Philippines</option><option value="Afghanistan">Afghanistan</option><option value="Albania">Albania</option><option value="Algeria">Algeria</option><option value="American Samoa">American Samoa</option><option value="Andorra">Andorra</option><option value="Angola">Angola</option><option value="Anguilla">Anguilla</option><option value="Antarctica">Antarctica</option><option value="Antigua and Barbuda">Antigua and Barbuda</option><option value="Argentina">Argentina</option><option value="Armenia">Armenia</option><option value="Aruba">Aruba</option><option value="Australia">Australia</option><option value="Austria">Austria</option><option value="Azerbaijan">Azerbaijan</option><option value="Bahamas">Bahamas</option><option value="Bahrain">Bahrain</option><option value="Bangladesh">Bangladesh</option><option value="Barbados">Barbados</option><option value="Belarus">Belarus</option><option value="Belgium">Belgium</option><option value="Belize">Belize</option><option value="Benin">Benin</option><option value="Bermuda">Bermuda</option><option value="Bhutan">Bhutan</option><option value="Bolivia">Bolivia</option><option value="Bosnia and Herzegowina">Bosnia and Herzegowina</option><option value="Botswana">Botswana</option><option value="Bouvet Island">Bouvet Island</option><option value="Brazil">Brazil</option><option value="British Indian Ocean Territory">British Indian Ocean Territory</option><option value="Brunei Darussalam">Brunei Darussalam</option><option value="Bulgaria">Bulgaria</option><option value="Burkina Faso">Burkina Faso</option><option value="Burundi">Burundi</option><option value="Cambodia">Cambodia</option><option value="Cameroon">Cameroon</option><option value="Canada">Canada</option><option value="Cape Verde">Cape Verde</option><option value="Cayman Islands">Cayman Islands</option><option value="Central African Republic">Central African Republic</option><option value="Chad">Chad</option><option value="Chile">Chile</option><option value="China">China</option><option value="Christmas Island">Christmas Island</option><option value="Cocos (Keeling) Islands">Cocos (Keeling) Islands</option><option value="Colombia">Colombia</option><option value="Comoros">Comoros</option><option value="Congo">Congo</option><option value="Cook Islands">Cook Islands</option><option value="Costa Rica">Costa Rica</option><option value="Cote D&#039;Ivoire">Cote D&#039;Ivoire</option><option value="Croatia">Croatia</option><option value="Cuba">Cuba</option><option value="Cyprus">Cyprus</option><option value="Czech Republic">Czech Republic</option><option value="Denmark">Denmark</option><option value="Djibouti">Djibouti</option><option value="Dominica">Dominica</option><option value="Dominican Republic">Dominican Republic</option><option value="East Timor">East Timor</option><option value="Ecuador">Ecuador</option><option value="Egypt">Egypt</option><option value="El Salvador">El Salvador</option><option value="Equatorial Guinea">Equatorial Guinea</option><option value="Eritrea">Eritrea</option><option value="Estonia">Estonia</option><option value="Ethiopia">Ethiopia</option><option value="Falkland Islands (Malvinas)">Falkland Islands (Malvinas)</option><option value="Faroe Islands">Faroe Islands</option><option value="Fiji">Fiji</option><option value="Finland">Finland</option><option value="France">France</option><option value="France, Metropolitan">France, Metropolitan</option><option value="French Guiana">French Guiana</option><option value="French Polynesia">French Polynesia</option><option value="French Southern Territories">French Southern Territories</option><option value="Gabon">Gabon</option><option value="Gambia">Gambia</option><option value="Georgia">Georgia</option><option value="Germany">Germany</option><option value="Ghana">Ghana</option><option value="Gibraltar">Gibraltar</option><option value="Greece">Greece</option><option value="Greenland">Greenland</option><option value="Grenada">Grenada</option><option value="Guadeloupe">Guadeloupe</option><option value="Guam">Guam</option><option value="Guatemala">Guatemala</option><option value="Guinea">Guinea</option><option value="Guinea-bissau">Guinea-bissau</option><option value="Guyana">Guyana</option><option value="Haiti">Haiti</option><option value="Heard and Mc Donald Islands">Heard and Mc Donald Islands</option><option value="Honduras">Honduras</option><option value="Hong Kong">Hong Kong</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="India">India</option><option value="Indonesia">Indonesia</option><option value="Iran (Islamic Republic of)">Iran (Islamic Republic of)</option><option value="Iraq">Iraq</option><option value="Ireland">Ireland</option><option value="Israel">Israel</option><option value="Italy">Italy</option><option value="Jamaica">Jamaica</option><option value="Japan">Japan</option><option value="Jordan">Jordan</option><option value="Kazakhstan">Kazakhstan</option><option value="Kenya">Kenya</option><option value="Kiribati">Kiribati</option><option value="Korea, Democratic People&#039;s Republic of">Korea, Democratic People&#039;s Republic of</option><option value="Korea, Republic of">Korea, Republic of</option><option value="Kuwait">Kuwait</option><option value="Kyrgyzstan">Kyrgyzstan</option><option value="Lao People&#039;s Democratic Republic">Lao People&#039;s Democratic Republic</option><option value="Latvia">Latvia</option><option value="Lebanon">Lebanon</option><option value="Lesotho">Lesotho</option><option value="Liberia">Liberia</option><option value="Libyan Arab Jamahiriya">Libyan Arab Jamahiriya</option><option value="Liechtenstein">Liechtenstein</option><option value="Lithuania">Lithuania</option><option value="Luxembourg">Luxembourg</option><option value="Macau">Macau</option><option value="Macedonia, The Former Yugoslav Republic of">Macedonia, The Former Yugoslav Republic of</option><option value="Madagascar">Madagascar</option><option value="Malawi">Malawi</option><option value="Malaysia">Malaysia</option><option value="Maldives">Maldives</option><option value="Mali">Mali</option><option value="Malta">Malta</option><option value="Marshall Islands">Marshall Islands</option><option value="Martinique">Martinique</option><option value="Mauritania">Mauritania</option><option value="Mauritius">Mauritius</option><option value="Mayotte">Mayotte</option><option value="Mexico">Mexico</option><option value="Micronesia, Federated States of">Micronesia, Federated States of</option><option value="Moldova, Republic of">Moldova, Republic of</option><option value="Monaco">Monaco</option><option value="Mongolia">Mongolia</option><option value="Montserrat">Montserrat</option><option value="Morocco">Morocco</option><option value="Mozambique">Mozambique</option><option value="Myanmar">Myanmar</option><option value="Namibia">Namibia</option><option value="Nauru">Nauru</option><option value="Nepal">Nepal</option><option value="Netherlands">Netherlands</option><option value="Netherlands Antilles">Netherlands Antilles</option><option value="New Caledonia">New Caledonia</option><option value="New Zealand">New Zealand</option><option value="Nicaragua">Nicaragua</option><option value="Niger">Niger</option><option value="Nigeria">Nigeria</option><option value="Niue">Niue</option><option value="Norfolk Island">Norfolk Island</option><option value="Northern Mariana Islands">Northern Mariana Islands</option><option value="Norway">Norway</option><option value="Oman">Oman</option><option value="Pakistan">Pakistan</option><option value="Palau">Palau</option><option value="Panama">Panama</option><option value="Papua New Guinea">Papua New Guinea</option><option value="Paraguay">Paraguay</option><option value="Peru">Peru</option><option value="Pitcairn">Pitcairn</option><option value="Poland">Poland</option><option value="Portugal">Portugal</option><option value="Puerto Rico">Puerto Rico</option><option value="Qatar">Qatar</option><option value="Reunion">Reunion</option><option value="Romania">Romania</option><option value="Russian Federation">Russian Federation</option><option value="Rwanda">Rwanda</option><option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option><option value="Saint Lucia">Saint Lucia</option><option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option><option value="Samoa">Samoa</option><option value="San Marino">San Marino</option><option value="Sao Tome and Principe">Sao Tome and Principe</option><option value="Saudi Arabia">Saudi Arabia</option><option value="Senegal">Senegal</option><option value="Seychelles">Seychelles</option><option value="Sierra Leone">Sierra Leone</option><option value="Singapore">Singapore</option><option value="Slovakia (Slovak Republic)">Slovakia (Slovak Republic)</option><option value="Slovenia">Slovenia</option><option value="Solomon Islands">Solomon Islands</option><option value="Somalia">Somalia</option><option value="South Africa">South Africa</option><option value="South Georgia and the South Sandwich Islands">South Georgia and the South Sandwich Islands</option><option value="Spain">Spain</option><option value="Sri Lanka">Sri Lanka</option><option value="St. Helena">St. Helena</option><option value="St. Pierre and Miquelon">St. Pierre and Miquelon</option><option value="Sudan">Sudan</option><option value="Suriname">Suriname</option><option value="Svalbard and Jan Mayen Islands">Svalbard and Jan Mayen Islands</option><option value="Swaziland">Swaziland</option><option value="Sweden">Sweden</option><option value="Switzerland">Switzerland</option><option value="Syrian Arab Republic">Syrian Arab Republic</option><option value="Taiwan">Taiwan</option><option value="Tajikistan">Tajikistan</option><option value="Tanzania, United Republic of">Tanzania, United Republic of</option><option value="Thailand">Thailand</option><option value="Togo">Togo</option><option value="Tokelau">Tokelau</option><option value="Tonga">Tonga</option><option value="Trinidad and Tobago">Trinidad and Tobago</option><option value="Tunisia">Tunisia</option><option value="Turkey">Turkey</option><option value="Turkmenistan">Turkmenistan</option><option value="Turks and Caicos Islands">Turks and Caicos Islands</option><option value="Tuvalu">Tuvalu</option><option value="Uganda">Uganda</option><option value="Ukraine">Ukraine</option><option value="United Arab Emirates">United Arab Emirates</option><option value="United Kingdom">United Kingdom</option><option value="United States">United States</option><option value="United States Minor Outlying Islands">United States Minor Outlying Islands</option><option value="Uruguay">Uruguay</option><option value="Uzbekistan">Uzbekistan</option><option value="Vanuatu">Vanuatu</option><option value="Vatican City State (Holy See)">Vatican City State (Holy See)</option><option value="Venezuela">Venezuela</option><option value="Viet Nam">Viet Nam</option><option value="Virgin Islands (British)">Virgin Islands (British)</option><option value="Virgin Islands (U.S.)">Virgin Islands (U.S.)</option><option value="Wallis and Futuna Islands">Wallis and Futuna Islands</option><option value="Western Sahara">Western Sahara</option><option value="Yemen">Yemen</option><option value="Yugoslavia">Yugoslavia</option><option value="Zaire">Zaire</option><option value="Zambia">Zambia</option><option value="Zimbabwe">Zimbabwe</option></select>
</div>
<div class="form-item" id="edit-profile-gender-wrapper">
 <label for="edit-profile-gender">Gender: <span class="form-required" title="This field is required.">*</span></label>
 <select name="profile_gender" class="form-select required" id="edit-profile-gender" ><option value="Male">Male</option><option value="Female">Female</option></select>
</div>
<div class="form-item" id="edit-profile-dob-wrapper">
 <label for="edit-profile-dob">Birthdate: <span class="form-required" title="This field is required.">*</span></label>
 <div class="container-inline"><div class="form-item" id="edit-profile-dob-month-wrapper">

 <select name="profile_dob[month]" class="form-select" id="edit-profile-dob-month" ><option value="1">Jan</option><option value="2" selected="selected">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option></select>
</div>
<div class="form-item" id="edit-profile-dob-day-wrapper">
 <select name="profile_dob[day]" class="form-select" id="edit-profile-dob-day" ><option value="1">1</option><option value="2" selected="selected">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option></select>

</div>
<div class="form-item" id="edit-profile-dob-year-wrapper">
 <select name="profile_dob[year]" class="form-select" id="edit-profile-dob-year" ><option value="1900">1900</option><option value="1901">1901</option><option value="1902">1902</option><option value="1903">1903</option><option value="1904">1904</option><option value="1905">1905</option><option value="1906">1906</option><option value="1907">1907</option><option value="1908">1908</option><option value="1909">1909</option><option value="1910">1910</option><option value="1911">1911</option><option value="1912">1912</option><option value="1913">1913</option><option value="1914">1914</option><option value="1915">1915</option><option value="1916">1916</option><option value="1917">1917</option><option value="1918">1918</option><option value="1919">1919</option><option value="1920">1920</option><option value="1921">1921</option><option value="1922">1922</option><option value="1923">1923</option><option value="1924">1924</option><option value="1925">1925</option><option value="1926">1926</option><option value="1927">1927</option><option value="1928">1928</option><option value="1929">1929</option><option value="1930">1930</option><option value="1931">1931</option><option value="1932">1932</option><option value="1933">1933</option><option value="1934">1934</option><option value="1935">1935</option><option value="1936">1936</option><option value="1937">1937</option><option value="1938">1938</option><option value="1939">1939</option><option value="1940">1940</option><option value="1941">1941</option><option value="1942">1942</option><option value="1943">1943</option><option value="1944">1944</option><option value="1945">1945</option><option value="1946">1946</option><option value="1947">1947</option><option value="1948">1948</option><option value="1949">1949</option><option value="1950">1950</option><option value="1951">1951</option><option value="1952">1952</option><option value="1953">1953</option><option value="1954">1954</option><option value="1955">1955</option><option value="1956">1956</option><option value="1957">1957</option><option value="1958">1958</option><option value="1959">1959</option><option value="1960">1960</option><option value="1961">1961</option><option value="1962">1962</option><option value="1963">1963</option><option value="1964">1964</option><option value="1965">1965</option><option value="1966">1966</option><option value="1967">1967</option><option value="1968">1968</option><option value="1969">1969</option><option value="1970">1970</option><option value="1971">1971</option><option value="1972">1972</option><option value="1973">1973</option><option value="1974">1974</option><option value="1975">1975</option><option value="1976">1976</option><option value="1977">1977</option><option value="1978">1978</option><option value="1979">1979</option><option value="1980">1980</option><option value="1981">1981</option><option value="1982">1982</option><option value="1983">1983</option><option value="1984">1984</option><option value="1985">1985</option><option value="1986">1986</option><option value="1987">1987</option><option value="1988">1988</option><option value="1989">1989</option><option value="1990">1990</option><option value="1991">1991</option><option value="1992">1992</option><option value="1993">1993</option><option value="1994">1994</option><option value="1995">1995</option><option value="1996">1996</option><option value="1997">1997</option><option value="1998">1998</option><option value="1999">1999</option><option value="2000">2000</option><option value="2001">2001</option><option value="2002">2002</option><option value="2003">2003</option><option value="2004">2004</option><option value="2005">2005</option><option value="2006">2006</option><option value="2007">2007</option><option value="2008">2008</option><option value="2009">2009</option><option value="2010">2010</option><option value="2011">2011</option><option value="2012" selected="selected">2012</option><option value="2013">2013</option><option value="2014">2014</option><option value="2015">2015</option><option value="2016">2016</option><option value="2017">2017</option><option value="2018">2018</option><option value="2019">2019</option><option value="2020">2020</option><option value="2021">2021</option><option value="2022">2022</option><option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option><option value="2031">2031</option><option value="2032">2032</option><option value="2033">2033</option><option value="2034">2034</option><option value="2035">2035</option><option value="2036">2036</option><option value="2037">2037</option><option value="2038">2038</option><option value="2039">2039</option><option value="2040">2040</option><option value="2041">2041</option><option value="2042">2042</option><option value="2043">2043</option><option value="2044">2044</option><option value="2045">2045</option><option value="2046">2046</option><option value="2047">2047</option><option value="2048">2048</option><option value="2049">2049</option><option value="2050">2050</option></select></fieldset>
<input id="edit-submit" class="form-submit" type="submit" value="Update account" name="op">
</div>
</div>
</div></form>';	

	return $html.$sBoxJS;

}

function fboauth_theme() {
  return array(
    'fboauth_action' => array(
      'pattern' => 'fboauth_action__[a-z0-9_]+',
      'arguments' => array('action' => NULL, 'properties' => NULL),
    ),
    'fboauth_action__connect' => array(
      'arguments' => array('action' => NULL, 'properties' => NULL),
    ),
    'fboauth_user_form_connect' => array(
      'arguments' => array('uid' => NULL, 'fbid' => NULL),
    ),
    'fboauth_user_info' => array(
      'arguments' => array('account' => NULL),
      'file' => 'includes/fboauth.pages.inc',
    ),
  );
}

/**
 * Implements hook_block().
 */
function fboauth_block($op = 'list', $delta = '', $edit = array()) {
  switch ($op) {
    case 'list':
      return fboauth_block_info();
    case 'view':
      return fboauth_block_view($delta);
  }
}

/**
 * Implements hook_block_info().
 */
function fboauth_block_info() {
  $blocks['login'] = array(
    'info' => t('Facebook login'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function fboauth_block_view($delta) {
  $block = array();
  $app_id = isset($app_id) ? $app_id : variable_get('fboauth_id', '');
  if ($app_id && !fboauth_fbid_load()) {
    $block['content'] = fboauth_action_display('connect');
  }
  return $block;
}

/**
 * Implements hook_user().
 */
function fboauth_user($op, &$edit, &$account, $category = NULL) {

  global $base_url;
  global $user;
  switch ($op) {
    case 'insert':
      fboauth_user_insert($edit, $account, $category);
      break;
    case 'update':
      fboauth_user_update($edit, $account, $category);
      break;
    case 'delete':
      fboauth_user_delete($account);
      break;

  }
  


  $inactive = db_result(db_query("select inactive from users where uid = '{$account->uid}'"));
  $status = db_result(db_query("select status from users where uid = '{$account->uid}'"));
  $password = db_result(db_query("select pass from users where uid = '{$account->uid}'"));
  //user_authenticate(array("name" => $name, "pass" => "default"));
  if ( $user->uid == $account->uid ) {
	if ($password == 'c21f969b5f03d33d43e04f8f136e7682'){

		$path = $_SERVER['REQUEST_URI'];

		#_change_info($account->uid); // 

		//echo '<script>location.href="http://www.hopecybary.org/fboauth/changeinfo/'.$account->uid.'";</script>';

	} else if($inactive == '5' && $status == '0'){
		if($user->uid !== '1'){
			echo '<script>alert("Your account is currently pending, we will notify you as soon as possible by email when it is approved.");
			location.href="'.$base_url.'";</script>';
		}
	} 
  }
  
  
}

/**
 * Implements hook_user_insert().
 */
function fboauth_user_insert(&$edit, &$account, $category) {
  if (isset($edit['fboauth_fbid'])) {
    fboauth_save($account->uid, $edit['fboauth_fbid']);
  }
}

/**
 * Implements hook_user_update().
 */
function fboauth_user_update(&$edit, &$account, $category) {

  if (isset($edit['fboauth_fbid'])) {
    fboauth_save($account->uid, $edit['fboauth_fbid']);
  }
}

/**
 * Implements hook_user_delete().
 */
function fboauth_user_delete($account) {
  // Passing in a NULL $fbid deletes any existing associations.
  fboauth_save($account->uid, NULL);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function fboauth_form_user_profile_form_alter(&$form, &$form_state) {
global $user;

 if($user->uid !== '1'){
  $uid = $form['#uid'];
  $fbid = fboauth_fbid_load($uid);

  $fboauth_form = array(
    '#type' => 'item',
    '#title' => t('Facebook connect'),
    '#children' => theme('fboauth_user_form_connect', $uid, $fbid),
  );

  // The account settings move around in this form.
  $account_form = isset($form['account']) ? $form['account'] : $form;

  // Inject the Facebook options after the e-mail settings. No weights are on
  // these elements by default, so we have to put it in order.
  $temp_form = array();
  foreach (element_children($account_form) as $child) {
    $temp_form[$child] = $account_form[$child];
    if ($child == 'mail') {
      if (isset($temp_form[$child]['#weight'])) {
        $fboauth_form['#weight'] = $temp_form[$child]['#weight'];
      }
      $temp_form['fboauth'] = $fboauth_form;
    }
    unset($account_form[$child]);
  }

  $account_form += $temp_form;
  if (isset($form['account'])) {
    $form['account'] = $account_form;
  }
  else {
    $form = $account_form;
  }
 }
}

/**
 * Implements hook_fboauth_actions().
 */
function fboauth_fboauth_actions() {
  $actions = array();

  $actions['connect'] = array(
    'title' => t('Connect'),
    'file' => 'includes/fboauth.fboauth.inc',
    'callback' => 'fboauth_action_connect',
    'permissions' => array_keys(fboauth_user_connect_permissions()),
    'theme callback' => 'fboauth_connect_link',
  );
  $actions['deauth'] = array(
    'title' => t('Deauthorize'),
    'file' => 'includes/fboauth.fboauth.inc',
    'callback' => 'fboauth_action_deauth',
    'theme callback' => 'fboauth_deauth_link',
  );
  return $actions;
}

/**
 * Load a Facebook OAuth action.
 *
 * This function searches available actions provided by hook_fboauth_actions().
 */
function fboauth_action_load($action_name) {
  static $actions;

  // Build the list of all available actions.
  if (!isset($actions)) {
    $actions = array();
    module_load_include('inc', 'fboauth', 'includes/fboauth.fboauth');

    foreach (module_implements('fboauth_actions') as $module) {
      if ($module_actions = module_invoke($module, 'fboauth_actions')) {
        foreach ($module_actions as $module_action_name => $module_action) {
          $module_action['name'] = $module_action_name;
          $module_action['module'] = $module;
          $module_action['file path'] = isset($module_action['file path']) ? $module_action['file path'] : drupal_get_path('module', $module);
          $module_action['properties'] = isset($module_action['properties']) ? $module_action['properties'] : array();
          $module_action['connections'] = isset($module_action['connections']) ? $module_action['connections'] : array();
          $module_action['permissions'] = isset($module_action['permissions']) ? $module_action['permissions'] : array();
          $actions[$module_action_name] = $module_action;
        }
      }
    }

    drupal_alter('fboauth_actions', $actions);
  }

  $action = isset($actions[$action_name]) ? $actions[$action_name] : FALSE;

  // Include any necessary includes for the file.
  if ($action) {
    if (isset($action['file'])) {
      $file = './' . $action['file path'] . '/' . $action['file'];
      if (file_exists($file)) {
        include_once $file;
      }
    }
  }

  return $action;
}

/**
 * Load a Facebook ID given a Drupal User ID.
 */
function fboauth_fbid_load($uid = NULL) {
  $uid = isset($uid) ? $uid : $GLOBALS['user']->uid;
  $result = db_query("SELECT fbid FROM {fboauth_users} WHERE uid = %d", $uid);
  $fbid = db_result($result);
  return $fbid ? (int) $fbid : FALSE;
}

/**
 * Load a Drupal User ID given a Facebook ID.
 */
function fboauth_uid_load($fbid) {
  $result = db_query("SELECT uid FROM {fboauth_users} WHERE fbid = %d", $fbid);
  $uid = db_result($result);
  return $uid ? (int) $uid : FALSE;
}

/**
 * Save a Drupal User ID to Facebook ID pairing.
 *
 * Passing in NULL for $fbid can also be used to delete a UID to FBID pairing.
 */
function fboauth_save($uid, $fbid) {
global $user;

  // Delete the existing Facebook ID if present for this Drupal user.
  $delete_query = 'DELETE FROM {fboauth_users} WHERE uid = %d';
  $delete_arguments = array($uid);

  // If setting a new Facebook ID for an account, also make sure no other
  // Drupal account is connected with this Facebook ID.
  if (isset($fbid)) {
    $delete_query .= ' OR fbid = %d';
    $delete_arguments[] = $fbid;
  }

  db_query($delete_query, $delete_arguments);
  if (!empty($fbid)) {
    db_query('INSERT INTO {fboauth_users} (uid, fbid) VALUES (%d, %d)', $uid, $fbid);
 }
  // redirect
  if (!empty($fbid)) {	
	if($user->uid !== '1'){
	db_query("INSERT INTO {users_roles} (uid, rid) VALUES ('{$uid}', '2')");
	db_query("UPDATE {users} SET status = '0' WHERE uid = '{$uid}'");
	db_query("UPDATE {users} SET inactive = '5' WHERE uid = '{$uid}'");
	db_query("UPDATE {users} SET pass = 'c21f969b5f03d33d43e04f8f136e7682' WHERE uid = '{$uid}'");
	 
		_change_info($uid);
	   //echo '<script>location.href="http://www.hopecybary.org/fboauth/changeinfo/'.$account->uid.'";</script>';
	  
	}
  }
}



/**
 * Output a Facebook link.
 *
 * This is simply a convience function for outputing a link. If wanting to
 * customize the display of the link, override the theme_fboauth_connect_link()
 * function in your theme.
 *
 * @param $action_name
 *   The name of the action to display (usually as a link or button). Facebook
 *   OAuth includes the "connect" and "deauth" actions by default.
 * @param $redirect
 *   An optional URL to redirect the user to after the action is completed. Note
 *   that if a destination is set in the URL through $_GET['destination'], that
 *   destination will take precedence.
 * @param $app_id
 *   The optional Facebook App ID under which this action will be executed. If
 *   omitted the default App ID is used.
 *
 * @see theme_fboauth_action()
 */
function fboauth_action_display($action_name, $redirect = NULL, $app_id = NULL) {
  // Use the default App ID if not specified.
  $app_id = isset($app_id) ? $app_id : variable_get('fboauth_id', '');

  $action = fboauth_action_load($action_name);
  $link = fboauth_action_link_properties($action_name, $redirect, $app_id);
  $theme = isset($action['theme']) ? $action['theme'] : array('fboauth_action__' . $action_name, 'fboauth_action');
  return theme($theme, $action, $link);
}

/**
 * Return a set of properties suitable for use to a url() call.
 */
function fboauth_action_link_properties($action_name, $redirect = NULL, $app_id = NULL) {
  // Use the default App ID if not specified.
  $app_id = isset($app_id) ? $app_id : variable_get('fboauth_id', '');
  $action = fboauth_action_load($action_name);

  // Determine the required permissions for this action.
  if (!empty($action['permissions'])) {
    $permissions = $action['permissions'];
  }
  elseif (!empty($action['properties']) || !empty($action['connections'])) {
    $properties = $action['properties'];
    $connections = $action['connections'];
    $permissions = array_keys(fboauth_user_permissions(array_merge($properties, $connections)));
  }
  else {
    $permissions = array();
  }

  // Build the return query string.
  $query = array();
  if (isset($redirect)) {
    $query['destination'] = $redirect;
  }
  elseif (!empty($_GET['destination'])) {
    $query['destination'] = $_GET['destination'];
  }

  $return = array(
    'query' => array(
      'client_id' => $app_id,
      'redirect_uri' => fboauth_action_url('fboauth/' . $action_name, array('absolute' => TRUE, 'query' => $query)),
    ),
    'href' => 'https://www.facebook.com/dialog/oauth',
  );

  if ($permissions) {
    $return['query']['scope'] = implode(',', $permissions);
  }

  return $return;
}

/**
 * Helper function to properly encode slashes in URLs.
 *
 * This function operates exactly like the core url() function, only it encodes
 * forward-slashes as "%2f", which Drupal intentionally avoids in its own url()
 * function. Encoded slashes are necessary to prevent Facebook from rejecting
 * the return_uri property.
 */
function fboauth_action_url($path = NULL, array $options = array()) {
  $url = url($path, $options);
  
  $query_pos = strpos($url, '?');
  if ($query_pos !== FALSE) {
    $url_string = substr($url, 0, $query_pos);
    $query_string = substr($url, $query_pos);
    $url = $url_string . str_replace('/', '%2F', $query_string);
	$url = $url_string . str_replace('visitor', 'www', $url);
  }
  $url = $url_string . str_replace('visitor', 'www', $url);

  return $url;
}

/**
 * Return a link to initiate a Facebook Connect login or association.
 *
 * @param $link
 *   An array of properties to be used to generate a login link. Note that all
 *   provided properties are required for the Facebook login to succeed and
 *   must not be changed. If $link is FALSE, Facebook OAuth is not yet
 *   configured.
 * @see fboauth_link_properties()
 */
function theme_fboauth_action($action, $link) {
  // Because most Facebook actions initiate one-time actions, render it as a
  // button instead of a link. This makes for expected behavior that buttons
  // execute actions, not links.
  $link['attributes']['class'] = isset($link['attributes']['class']) ? $link['attributes']['class'] : 'form-button facebook-button facebook-action-' . str_replace('_', '-', $action['name']);
  $link['attributes']['name'] = isset($link['attributes']['name']) ? $link['attributes']['name'] : 'facebook_action_' . $action['name'];
  $link['attributes']['type'] = 'button';
  $attributes = drupal_attributes($link['attributes']);
  $url = url(str_replace('visitor', 'www', $link['href']), array('query' => $link['query']));
  $content = '<button ' . $attributes . ' onclick="window.location = \'' . $url . '\'; return false;">' . check_plain($action['title']) . '</button>';
  return $content;
}

/**
 * Return a link to initiate a Facebook Connect login or association.
 *
 * @param $link
 *   An array of properties to be used to generate a login link. Note that all
 *   provided properties are required for the Facebook login to succeed and
 *   must not be changed. If $link is FALSE, Facebook OAuth is not yet
 *   configured.
 * @see fboauth_link_properties()
 */
function theme_fboauth_action__connect($action, $link) {
  $url = url(str_replace('visitor', 'www', $link['href']), array('query' => $link['query']));
  $link['attributes']['class'] = isset($link['attributes']['class']) ? $link['attributes']['class'] : 'facebook-action-connect';
  $attributes = isset($link['attributes']) ? drupal_attributes($link['attributes']) : '';
  $title = isset($link['title']) ? check_plain($link['title']) : '';
  return '<a ' . $attributes . ' href="' . $url . '"><img src="'. drupal_get_path('theme',$GLOBALS['theme'])
 .'/images/fb.png" alt="' . $title . '" /></a>';
}

/**
 * Display the Facebook Connect options on a user's profile form.
 */
function theme_fboauth_user_form_connect($uid, $fbid) {

  if ($fbid) {
    $output = t('Your account is connected with Facebook.', array('!url' => url('user/' . $uid . '/fboauth')));
  }
  else {
    $output = fboauth_action_display('connect');
    $output .= '<div class="description">' . t('Connect with Facebook to login with your Facebook account instead of a password.') . '</div>';
  }
  return $output;
 
}
